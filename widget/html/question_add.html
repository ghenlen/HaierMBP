<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>title</title>
		<script type="text/javascript" src="../script/generalCSS.js"></script>
		<style>
            .aui-list:before, .aui-list:after {
                background-color: #fff;
            }
		</style>
	</head>
	<body>
		<header class="aui-bar aui-bar-nav">
			<a class="aui-pull-left aui-btn" onclick="back()"> <span class="aui-iconfont aui-icon-left"></span></a>
			<div class="aui-title aui-font-size-18">
				<label class="i18n_label" id="newquestion"></label>
			</div>
		</header>
		<div class="aui-content"  id="container" style="margin-bottom: 4rem;">
			<div class="aui-content aui-margin-b-15">
				<ul class="aui-list aui-form-list aui-margin-b-10">
					<li class="aui-list-item">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-title" >
								<label class="i18n_label" id="questionType"></label>:
							</div>
							<div class="aui-list-item-right" align="right" style="width: 55%;margin-right: 1.1rem;">
								<label>
									<input class="aui-radio question_type" style="width: 1rem;height: 1rem;border-radius: 0.5rem;" type="radio" name="questionType" value="INNER" onclick="changeType('CUSTOMER')" checked>
									<label class="i18n_label" id="internal"style="color: #9e9e9e;"></label></label>
								<label>
									<input class="aui-radio question_type" style="width: 1rem;height: 1rem;border-radius: 0.5rem;color: #9e9e9e;" type="radio" name="questionType" onclick="changeType('INNER')" value="CUSTOMER">
									<label class="i18n_label" id="dealer" style="color: #9e9e9e;"></label> </label>
							</div>
						</div>
					</li>
					<li class="aui-list-item" id="reportToLi">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-title">
								<label class="i18n_label" id="reportTo"></label>:
							</div>
							<div class="aui-list-item-right" align="right" style="width: 55%;margin-right: 1.1rem;">
								<label>
									<input class="aui-radio report_to" style="width: 1rem;height: 1rem;border-radius: 0.5rem;" type="radio" value="HO" name="reportTo" checked>
									<label class="i18n_label" id="HO" style="color: #9e9e9e;"></label> &nbsp;&nbsp;&nbsp;&nbsp;</label>
								&nbsp; <label id="branchRadio">
									<input class="aui-radio report_to" style="width: 1rem;height: 1rem;border-radius: 0.5rem;" type="radio" value="BRANCH" name="reportTo">
									<label class="i18n_label" id="branch" style="color: #9e9e9e;"></label> </label>
							</div>
						</div>
					</li>
					<li class="aui-list-item aui-hide" id="dealerLi">
						<div class="aui-list-item-inner  aui-list-item-arrow">
							<div class="aui-list-item-title">
								<label class="i18n_label" id="dealer"></label>:
							</div>
							<div style="width: 65%;text-align: right;margin-right: 1.1rem;" onclick="showDealerActionSelector()">
								<div class="show_text aui-text-info" id="dealerName"></div>
							</div>
						</div>
					</li>
				</ul>
				<ul class="aui-list aui-form-list aui-margin-b-10">
					<li class="aui-list-item">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-input">
								<input type="text" id="titleInput" placeholder="Question Title" onKeyDown="textCounter();" onKeyUp="textCounter();" oninput="textCounter()">
							</div>
						</div>
					</li>
				</ul>
				<ul class="aui-list aui-form-list aui-margin-b-10">
					<li class="aui-list-item">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-input">
								<textarea  id="content" placeholder="Question Body" style="height:150px;border-radius: 4px;"></textarea>
							</div>
						</div>
					</li>
				</ul>
				<ul class="aui-list aui-form-list">
					<li class="aui-list-item" id="productDivisionOptionsLi">
						<div class="aui-list-item-inner aui-list-item-arrow">
							<div class="aui-list-item-title">
								<label class="i18n_label" id="productDivision"></label>:
							</div>
							<div class="aui-list-item-left aui-text-info" style="width: 55%;text-align: right;margin-right: 1.1rem;" id="productDivisionText" onclick="showActionSelector(1)">
								Product Division
							</div>
						</div>
					</li>
					<li class="aui-list-item">
						<div class="aui-list-item-inner aui-list-item-arrow">
							<div class="aui-list-item-title">
								Support Dept:
							</div>
							<div class="aui-list-item-left aui-text-info" style="width: 65%;text-align: right;margin-right: 1.1rem;" id="categoryText" onclick="showActionSelector(2)"></div>
						</div>
					</li>
					<li class="aui-list-item">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-title" style="width: 30%;">
								<label class="i18n_label" id="sender"></label>:
							</div>
							<div class="aui-list-item-input" >
								<input type="text" id="senderInput" class="aui-ellipsis-1" style="display: inline-block" placeholder="Enter Sender">
							</div>
						</div>
					</li>
					<li class="aui-list-item">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-title" style="width: 30%;">
								<label class="i18n_label" id="phone"></label>:
							</div>
							<div class="aui-list-item-input">
								<input type="text" id="phoneInput" placeholder="Enter Phone">
							</div>
						</div>
					</li>
					<li class="aui-list-item">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-title" style="width: 30%;">
								<label class="i18n_label" id="email"></label>:
							</div>
							<div class="aui-list-item-input">
								<input type="text" id="emailInput" placeholder="Enter Email">
							</div>
						</div>
					</li>
				</ul>
			</div>
		</div>
		<footer style="position: fixed;bottom: 0;left: 0;height: 3rem;width: 100%;background: #DDDDDD;z-index: 111;" align="center">
			<div class="aui-btn aui-btn-info" id="submit" style="width: 90%;margin-top: 0.5rem;">
				<label class="i18n_label" id="submit"></label>
			</div>
		</footer>
		<input type="hidden" id="customerCode"/>
		<input type="hidden" id="customerId"/>
		<input type="hidden" id="productDivisionValue"/>
		<input type="hidden" id="categoryValue"/>
	</body>
	<script type="text/javascript" src="../script/generalJS.js"></script>
	<script type="text/javascript">
		var dialog = new auiDialog({});
		var questionId;
		var questionStatus;
		var userInfo = $api.getStorage("userInfo");
		var categoryData = [];
		var productDivisionData = [];
		apiready = function() {
			var currentOrg = BUSINESS_GetCurrentOrg();
			getCategorySelectList();
			//getProductDivisionList();
			var pName = userInfo.name;
			var pMobile = userInfo.mobile;
			var pEmail = userInfo.email;
			$api.val($api.byId("senderInput"), pName);
			$api.val($api.byId("phoneInput"), pMobile);
			$api.val($api.byId("emailInput"), pEmail);
			var $header = $api.dom('header');
			$api.fixIos7Bar($header);
			$api.fixStatusBar($header);
			var headerHeight = $api.offset($header).h;
			COMMON_openFrame({
				name : 'question_add_head',
				url : 'question_add_head.html',
				rect : {
					x : 0,
					y : 0,
					w : api.winWidth,
					h : headerHeight
				},
				animation : CONSTANT_FRAME_ANIMATION
			});
			var pageParam = api.pageParam;
			initDealer();
			var post = BUSINESS_JudgeOrgType();
			if (post == 'REGION' || post == 'HO') {
				$api.addCls($api.byId('branchRadio'), 'aui-hide');
			}
			//保存问题
			$api.addEvt($api.byId('submit'), 'click', function() {
				var content = $api.val($api.byId('content'));
				var title = $api.val($api.byId('titleInput'));
				if ($api.trim(title) == '') {
					api.toast({
						msg : 'Please enter the title!'
					});
					return;
				}
				if ($api.trim(content) == '') {
					api.toast({
						msg : 'Please enter the content!'
					});
					return;
				}
				
				var productDivision = $api.val($api.byId("productDivisionValue"));
				if ($api.trim(productDivision) == '') {
					api.toast({
						msg : 'Please select the productDivision!'
					});
					return;
				}
				
				var sender = $api.val($api.byId('senderInput'));
				if ($api.trim(sender) == '') {
					api.toast({
						msg : 'Please enter the sender!'
					});
					return;
				}
				var email = $api.val($api.byId('emailInput'));
				if ($api.trim(email) != '') {
					var emailReg = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
					if (!emailReg.test(email)) {
						api.toast({
							msg : 'Please enter the correct email!'
						});
						return;
					}
				}
				
				var questionType = $api.val($api.dom('.question_type:checked'));
						var reportTo = $api.val($api.dom('.report_to:checked'));
						var category = $api.val($api.byId("categoryValue"));
						
						var dealer = $api.val($api.byId('customerId'));
						var orgId = BUSINESS_GetOrgId();
						var sender = $api.val($api.byId('senderInput'));
						var phone = $api.val($api.byId('phoneInput'));
						var email = $api.val($api.byId('emailInput'));
						var param;
						if (questionType == 'INNER') {
							param = {
								'content' : content,
								'title' : title,
								'type' : questionType,
								'category' : category,
								'productGroup' : productDivision,
								'org.id' : orgId,
								'orgType' : reportTo,
								'user.id' : userInfo.id,
								'questionName' : sender,
								'phone' : phone,
								'email' : email,
								'status' : 'INIT',
								'orgInnerCode' : currentOrg.orgInnerCode
							};
						} else {
							param = {
								'content' : content,
								'title' : title,
								'type' : questionType,
								'category' : category,
								'productGroup' : productDivision,
								'customer.id' : $api.val($api.byId('customerId')),
								'org.id' : orgId,
								'user.id' : userInfo.id,
								'questionName' : sender,
								'phone' : phone,
								'email' : email,
								'status' : 'INIT',
								'orgInnerCode' : currentOrg.orgInnerCode
							};
						}
						var saveQuestionHeadUrl = ajaxReqHost + 'appSaveQuestion.ajax';
						COMMON_Ajax_Post(saveQuestionHeadUrl, {
							values : param
						}, function(ret) {
							if (ret && ret.result == true) {
								COMMON_toastSuccess();
								setTimeout(function() {
									api.closeWin();
									api.sendEvent({
										name : 'refreshUnsolved'
									});
								}, 1200);
							} else {
								COMMON_ShowFailure(ret.msg);
							}
						});
				
				
			});
		};
		function changeType(type) {
			if (type == 'CUSTOMER') {
				var $reportToLi = $api.byId('reportToLi');
				var $dealerLi = $api.byId('dealerLi');
				//var $productDivisionOptionsLi = $api.byId('productDivisionOptionsLi');
				$api.removeCls($reportToLi, 'aui-hide');
				$api.addCls($reportToLi, 'aui-show');
				$api.removeCls($dealerLi, 'aui-show');
				$api.addCls($dealerLi, 'aui-hide');
				//$api.addCls($productDivisionOptionsLi, 'aui-hide');
			} else {
				var $reportToLi = $api.byId('reportToLi');
				var $dealerLi = $api.byId('dealerLi');
				//var $productDivisionOptionsLi = $api.byId('productDivisionOptionsLi');
				$api.removeCls($reportToLi, 'aui-show');
				$api.addCls($reportToLi, 'aui-hide');
				$api.removeCls($dealerLi, 'aui-hide');
				$api.addCls($dealerLi, 'aui-show');
				//$api.addCls($productDivisionOptionsLi, 'aui-show');
			}
		}

		function getCategorySelectList() {
			var url = ajaxReqHost + 'appGetDictionary.ajax';
			COMMON_Ajax_Post(url, {
				values : {
					dicType : 'QUESTION_CATEGORY'
				}
			}, function(ret) {
				if (ret && ret.length > 0) {
					//					var options = '';
					//					for (var i = 0; i < ret.length; i++) {
					//						var category = ret[i];
					//						options += '<option value="' + category.value + '">' + category.title + '</option>'
					//					}
					//					$api.html($api.byId('categorySelect'), options);
					for (var i = 0; i < ret.length; i++) {
						categoryData.push({
							id : ret[i].value,
							name : ret[i].title
						});
					}
					$api.html($api.byId('categoryText'), categoryData[0].name);
					$api.val($api.byId('categoryValue'), categoryData[0].id);
				}
			});
		}

		function getProductDivisionList() {
			var url = ajaxReqHost + 'appGetDictionary.ajax';
			COMMON_Ajax_Post(url, {
				values : {
					dicType : 'PRODUCT_GROUP_TYPE'
				}
			}, function(ret) {
				if (ret && ret.length > 0) {
					for (var i = 0; i < ret.length; i++) {
						productDivisionData.push({
							id : ret[i].value,
							name : ret[i].title
						});
					}
					$api.html($api.byId('productDivisionText'), productDivisionData[0].name);
					$api.val($api.byId('productDivisionValue'), productDivisionData[0].id);
				}
			});
		}

		function UPDATE_PRODUCTGROUP(pg) {
			$api.html($api.byId('productDivisionText'), pg.name);
			$api.val($api.byId('productDivisionValue'), pg.id);
		}

		function showDealerActionSelector() {
			COMMON_OpenWin({
				name : 'dealer_select',
				url : 'dealer_select.html',
				pageParam : {
					winName : "question_add",
					selected : $api.html($api.byId('dealerName'))
				}
			});
		}

		function showActionSelector(type) {
			if (type == 1) {
				var productGroup = $api.val($api.byId('productDivisionValue'));
				COMMON_OpenWin({
					name : 'product_group',
					url : 'product_group.html',
					pageParam : {
						winName : "question_add",
						selectedId : productGroup
					}
				});
				return;
			}
			var listData = [];
			if (type == 1) {
				listData = productDivisionData;
			} else if (type == 2) {
				listData = categoryData;
			}
			var buttons = [];
			for (var i = 0; i < listData.length; i++) {
				buttons.push(listData[i].name);
			}
			var title = '';
			if (type == 1) {//product division
				title = 'Selected: ' + $api.html($api.byId('productDivisionText'));
			} else if (type == 2) {// category
				title = 'Selected: ' + $api.html($api.byId('categoryText'));
			}
			COMMON_actionSheet(title, buttons, function(ret) {
				if (type == 1) {//product division
					$api.html($api.byId('productDivisionText'), listData[ret].name);
					$api.val($api.byId('productDivisionValue'), listData[ret].id);
				} else if (type == 2) {// category
					$api.html($api.byId('categoryText'), listData[ret].name);
					$api.val($api.byId('categoryValue'), listData[ret].id);
				}
			});
			return;
			COMMON_ActionSelector(listData, function(ret) {
				if (type == 1) {//product division
					$api.html($api.byId('productDivisionText'), ret.level1);
					$api.val($api.byId('productDivisionValue'), ret.selectedInfo[0].id);
				} else if (type == 2) {// category
					$api.html($api.byId('categoryText'), ret.level1);
					$api.val($api.byId('categoryValue'), ret.selectedInfo[0].id);
				}
			});
		}

		function UPDATE_DEALER(param) {
			var customerCode = param.customerCode;
			var customerId = param.customerId;
			var title = param.title;
			var saleOffice = param.saleOffice;
			var orgCode = param.orgCode;
			$api.html($api.byId('dealerName'), title);
			$api.val($api.byId('customerId'), customerId);
			$api.val($api.byId('customerCode'), customerCode);
			var dealer = {
				'customerCode' : customerCode,
				'customerTitle' : title,
				'customerId' : customerId,
				'saleOffice' : saleOffice,
				'orgCode' : orgCode
			};
			BUSINESS_UpdateCurrentDealer(userInfo.id, dealer);
		}

		function initDealer() {
			var relations = BUSINESS_GetRelations();
			var cacheDealer = BUSINESS_GetCurrentDealer(userInfo.id);
			if (cacheDealer) {
				$api.html($api.byId('dealerName'), (cacheDealer.customerTitle));
				$api.val($api.byId('customerCode'), cacheDealer.customerCode);
				$api.val($api.byId('customerId'), cacheDealer.customerId);
			} else if (relations && relations.length > 0) {
				$api.html($api.byId('dealerName'), (relations[0].customerTitle));
				$api.val($api.byId('customerCode'), relations[0].customerCode);
				$api.val($api.byId('customerId'), relations[0]['customer.id']);
			}
		}
		
		function textCounter() {
			var $title = $api.byId('titleInput');
			var value = $api.val($title);
			if (value.length > 80)
				$api.val($title, value.substring(0, 80))
		}
	</script>
</html>